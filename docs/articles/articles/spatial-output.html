<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial Output • nlrx</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Spatial Output">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">nlrx</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/spatial-output.html">Spatial Output</a>
    </li>
    <li>
      <a href="../../articles/getstarted.html">Get Started</a>
    </li>
    <li>
      <a href="../../articles/simdesign-examples.html">Simdesign examples</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nldoc/nlrx">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Spatial Output</h1>
                        <h4 class="author">Jan Salecker</h4>
            
            <h4 class="date">2018-10-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nldoc/nlrx/blob/master/vignettes/articles/spatial-output.Rmd"><code>vignettes/articles/spatial-output.Rmd</code></a></small>
      <div class="hidden name"><code>spatial-output.Rmd</code></div>

    </div>

    
    
<div id="gathering-spatial-output-from-netlogo-model-simulations" class="section level2">
<h2 class="hasAnchor">
<a href="#gathering-spatial-output-from-netlogo-model-simulations" class="anchor"></a>Gathering spatial output from NetLogo model simulations</h2>
<p>nlrx is able to gather spatial output from your NetLogo simulations. The experiment class object provides two slots for measuring turtles and patches. The metrics.turtles slot accepts any vector of strings containing valid turtles-own variables of your NetLogo model. The metrics.patches slot accepts any vector of strings containing valid patches-own variables of your NetLogo model. The metrics.links slot accepts any vector of strings containing valid links-own variables of your NetLogo model.</p>
<p>Basically, you can enter any variable of your model that is listed in turtles-own, patches-own or links-own, however if you add variables that contain strings, these strings must not contain any whitespaces or the output data will not be parsed correctly.</p>
<p>For instance, we might want to measure coordinates, who numbers and the breed of turtles, and coordinates of patches and the corresponding pcolor on each tick. We can then define our experiment and run the simulations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># Define nl object</span>
nl &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/nl.html">nl</a></span>(<span class="dt">nlversion =</span> <span class="st">"6.0.3"</span>,
         <span class="dt">nlpath =</span> <span class="st">"C:/Program Files/NetLogo 6.0.3/"</span>,
         <span class="dt">modelpath =</span> <span class="st">"C:/Program Files/NetLogo 6.0.3/app/models/Sample Models/Biology/Wolf Sheep Predation.nlogo"</span>,
         <span class="dt">jvmmem =</span> <span class="dv">1024</span>)

<span class="co"># Define experiment</span>
nl<span class="op">@</span>experiment &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/experiment.html">experiment</a></span>(<span class="dt">expname =</span> <span class="st">"nlrx_spatial"</span>,
                            <span class="dt">outpath=</span><span class="st">"C:/out/"</span>,
                            <span class="dt">repetition =</span> <span class="dv">1</span>,      
                            <span class="dt">tickmetrics =</span> <span class="st">"true"</span>,
                            <span class="dt">idsetup =</span> <span class="st">"setup"</span>,   
                            <span class="dt">idgo =</span> <span class="st">"go"</span>,         
                            <span class="dt">idfinal =</span> <span class="ot">NA_character_</span>,  
                            <span class="dt">idrunnum =</span> <span class="ot">NA_character_</span>,
                            <span class="dt">runtime =</span> <span class="dv">100</span>,
                            <span class="dt">evalticks =</span> <span class="kw">seq</span>(<span class="dv">1</span>,<span class="dv">100</span>),
                            <span class="dt">metrics =</span> <span class="kw">c</span>(<span class="st">"count sheep"</span>,<span class="st">"count wolves"</span>),
                            <span class="dt">metrics.turtles =</span> <span class="kw">c</span>(<span class="st">"who"</span>, <span class="st">"pxcor"</span>, <span class="st">"pycor"</span>, <span class="st">"breed"</span>),
                            <span class="dt">metrics.patches =</span> <span class="kw">c</span>(<span class="st">"pxcor"</span>, <span class="st">"pycor"</span>, <span class="st">"pcolor"</span>),
                            <span class="dt">constants =</span> <span class="kw">list</span>(<span class="st">"model-version"</span> =<span class="st"> "</span><span class="ch">\"</span><span class="st">sheep-wolves-grass</span><span class="ch">\"</span><span class="st">"</span>,
                                             <span class="st">'initial-number-sheep'</span> =<span class="st"> </span><span class="dv">100</span>,
                                             <span class="st">'initial-number-wolves'</span> =<span class="st"> </span><span class="dv">50</span>,
                                             <span class="st">"grass-regrowth-time"</span> =<span class="st"> </span><span class="dv">30</span>,
                                             <span class="st">"sheep-gain-from-food"</span> =<span class="st"> </span><span class="dv">4</span>,
                                             <span class="st">"wolf-gain-from-food"</span> =<span class="st"> </span><span class="dv">20</span>,
                                             <span class="st">"sheep-reproduce"</span> =<span class="st"> </span><span class="dv">4</span>,
                                             <span class="st">"wolf-reproduce"</span> =<span class="st"> </span><span class="dv">5</span>,
                                             <span class="st">"show-energy?"</span> =<span class="st"> "false"</span>)
                            )

<span class="co"># Attach simdesign simple using only constants</span>
nl<span class="op">@</span>simdesign &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/simdesign_simple.html">simdesign_simple</a></span>(<span class="dt">nl=</span>nl,
                                 <span class="dt">nseeds=</span><span class="dv">1</span>)

<span class="co"># Run simulations and store output in results</span>
future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(multisession)
results <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../../reference/run_nl_all.html">run_nl_all</a></span>(<span class="dt">nl =</span> nl, <span class="dt">cleanup =</span> <span class="st">"all"</span>)</code></pre></div>
<p>This experiment will run for 100 ticks and collects all metrics, metrics.turtles and metrics.patches on each tick. Thus, running run_nl_all() will report a tibble containing all metrics, metrics.turtles and metrics.patches. However, because the spatial metrics contain more than one value, these datasets are stored as lists inside the output tibble. This lists already contain all measured agent metrics and can for example be used to analyse distributions of these variables for specific agent groups.</p>
<p>In case of spatial data containing coordinates (pxcor/pycor for patches or pxcor/pycor and/or xcor/ycor for turtles), nlrx provides a function to transform the measured output into spatial objects. In order to use the function get_nl_spatial() you first have to attach your simulation output results to the nl object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Attach results to nl object:</span>
<span class="kw"><a href="../../reference/setsim.html">setsim</a></span>(nl, <span class="st">"simoutput"</span>) &lt;-<span class="st"> </span>results

<span class="co"># Report spatial data:</span>
results_spatial &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_nl_spatial.html">get_nl_spatial</a></span>(nl,
                                  <span class="dt">turtles =</span> <span class="ot">TRUE</span>,
                                  <span class="dt">patches =</span> <span class="ot">TRUE</span>,
                                  <span class="dt">turtle_coords =</span> <span class="st">"px"</span>,
                                  <span class="dt">format=</span><span class="st">"spatial"</span>)</code></pre></div>
<p>The get_nl_spatial() function uses 4 function parameters:</p>
<ul>
<li>turtles - TRUE/FALSE, if true the function will transform the measured metrics.turtles to spatial sf objects.</li>
<li>patches - TRUE/FALSE, if true the function will transform the measured metrics.patches to spatial raster objects. In case there are several patches variables besides the coordinates, the result will be a rasterstack containing one raster for each patch variable</li>
<li>turtle_coords - “px”/“x”, because turtle coordinates can be measured as pxcor/pycor or xcor/ycor this string defines which coordinates are used for creating the turtle sf objects. For instance, you can measure both coordinate pairs by entering them into metrics.turtles, and then decide for one type of coordinates to create spatial objects.</li>
<li>format - “spatial”/“tibble”, the “spatial” option will report the generated output as tibble containing the spatial objects (raster/rasterStack, sf). You can also choose format “tibble” report the spatial objects as a long format tibble, that can be used for plotting landscapes and turtles with ggplot2.</li>
</ul>
</div>
<div id="visualization-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#visualization-examples" class="anchor"></a>Visualization examples</h2>
<p>The spatial tibble output from get_nl_spatial() can for example be used to plot maps for different ticks of the model simulation. Here is an example to create a facet plot using spatial simulation data of every 10th simulation tick:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Report spatial data as tibble:</span>
results_spatial_tibble &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_nl_spatial.html">get_nl_spatial</a></span>(nl,
                                  <span class="dt">turtles =</span> <span class="ot">TRUE</span>,
                                  <span class="dt">patches =</span> <span class="ot">TRUE</span>,
                                  <span class="dt">turtle_coords =</span> <span class="st">"px"</span>,
                                  <span class="dt">format=</span><span class="st">"tibble"</span>)


results_spatial_tibble <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(step <span class="op">%in%</span><span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">80</span>,<span class="dv">10</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>step, <span class="dt">ncol=</span><span class="dv">4</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_equal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">x=</span>patches_x, <span class="dt">y=</span>patches_y, <span class="dt">fill=</span><span class="kw">factor</span>(pcolor))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> turtles_x, <span class="dt">y =</span> turtles_y, <span class="dt">color =</span> breed), <span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="st">"35"</span>, <span class="st">"55"</span>), <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"35"</span> =<span class="st"> "#D9AF6B"</span>, <span class="st">"55"</span> =<span class="st"> "#68855C"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="st">"sheep"</span>, <span class="st">"wolves"</span>), <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"sheep"</span> =<span class="st"> "beige"</span>, <span class="st">"wolves"</span> =<span class="st"> "black"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill=</span><span class="kw">guide_legend</span>(<span class="dt">title=</span><span class="st">"LandCover"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Output maps of each 10th simulation tick"</span>)</code></pre></div>
<p><img src="wolfsheep_world.png" align="center" width="100%"></p>
<p>Using the gganimate package(<a href="https://github.com/thomasp85/gganimate" class="uri">https://github.com/thomasp85/gganimate</a>), it is even possible to generate animated plots from this spatial data tibble. Here is an example for a plot that has been generated by running the above experiment and postprocessing the data with get_nl_spatial.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># Report spatial data as tibble:</span>
results_spatial_tibble &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/get_nl_spatial.html">get_nl_spatial</a></span>(nl,
                                  <span class="dt">turtles =</span> <span class="ot">TRUE</span>,
                                  <span class="dt">patches =</span> <span class="ot">TRUE</span>,
                                  <span class="dt">turtle_coords =</span> <span class="st">"px"</span>,
                                  <span class="dt">format=</span><span class="st">"tibble"</span>)

<span class="co"># Load libraries (gganimate available from https://github.com/thomasp85/gganimate)</span>
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(gganimate)

<span class="co"># Create an animated plot, using the step column as animation variable</span>
p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(results_spatial_tibble) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_tile</span>(<span class="kw">aes</span>(<span class="dt">x=</span>patches_x, <span class="dt">y=</span>patches_y, <span class="dt">fill=</span><span class="kw">factor</span>(pcolor))) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> turtles_x, <span class="dt">y =</span> turtles_y, <span class="dt">group=</span>who, <span class="dt">color =</span> breed), <span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="st">"35"</span>, <span class="st">"55"</span>), <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"35"</span> =<span class="st"> "#D9AF6B"</span>, <span class="st">"55"</span> =<span class="st"> "#68855C"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">breaks=</span><span class="kw">c</span>(<span class="st">"sheep"</span>, <span class="st">"wolves"</span>), <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"sheep"</span> =<span class="st"> "beige"</span>, <span class="st">"wolves"</span> =<span class="st"> "black"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill=</span><span class="kw">guide_legend</span>(<span class="dt">title=</span><span class="st">"LandCover"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">transition_time</span>(step) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_equal</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">'Step: {frame_time}'</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_void</span>()

<span class="co"># Animate the plot and use 1 frame for each step of the model simulations</span>
gganimate<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/gganimate/topics/animate">animate</a></span>(p1, <span class="dt">nframes =</span> <span class="kw">max</span>(results_spatial_tibble<span class="op">$</span>step), <span class="dt">width=</span><span class="dv">400</span>, <span class="dt">height=</span><span class="dv">400</span>, <span class="dt">fps=</span><span class="dv">4</span>)
<span class="kw">anim_save</span>(<span class="st">"wolfsheep_world.gif"</span>)</code></pre></div>
<center>
<img src="wolfsheep_world.gif" align="center" width="50%">
</center>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#gathering-spatial-output-from-netlogo-model-simulations">Gathering spatial output from NetLogo model simulations</a></li>
      <li><a href="#visualization-examples">Visualization examples</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Jan Salecker, Marco Sciaini.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
